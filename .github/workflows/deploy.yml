
name: Deploy to ECS

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: arn:aws:iam::854878589422:role/aisin-subroutine-ecs-role
        aws-region: ap-northeast-1
        audience: sts.amazonaws.com

    - name: ðŸ“¦ Deploy CloudFormation stack
      run: |
        echo "ðŸ“¦ Deploying CloudFormation stack..."
        aws cloudformation deploy \
          --template-file infra/deploy-cfn.yml \
          --stack-name kjtxt-ecs-stack-v2 \
          --capabilities CAPABILITY_NAMED_IAM \
          --region ap-northeast-1 \
          --no-fail-on-empty-changeset \
          --parameter-overrides \
            VpcId=vpc-00a864232967b482e \
            Subnet1=subnet-08575605bc6e74371 \
            Subnet2=subnet-0bd83c19cd2d031f4 \
            ALBSecurityGroupId=sg-07c55a885728e21e8 \
            ECSSecurityGroupId=sg-0f0f53729b7673f03

    - name: â³ Wait for CloudFormation stack to complete
      run: |
        echo "â³ Waiting for CloudFormation stack to complete..."
        aws cloudformation wait stack-create-complete \
          --stack-name kjtxt-ecs-stack-v2 \
          --region ap-northeast-1

    - name: ðŸ” Get ECS Cluster Name from CloudFormation Outputs
      id: get_cluster
      run: |
        CLUSTER_NAME=$(aws cloudformation describe-stacks \
          --stack-name kjtxt-ecs-stack-v2 \
          --region ap-northeast-1 \
          --query "Stacks[0].Outputs[?OutputKey=='ECSClusterName'].OutputValue" \
          --output text)
        echo "ECS Cluster Name: $CLUSTER_NAME"
        echo "cluster-name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
    - name: ðŸš€ Deploy to ECS
      run: |
        echo "ðŸš€ Updating ECS service..."
        aws ecs update-service \
          --cluster ${{ steps.get_cluster.outputs.cluster-name }} \
          --service kjtxt-service \
          --force-new-deployment \
          --region ap-northeast-1
